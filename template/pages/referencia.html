{% load static %}
<script src="{% static 'vendors/jquery/jquery-3.2.1.min.js' %}"></script>
{% block title %}Django Ajax CRUD{% endblock %}
id="user

<div id="openModalPadre" class="modalDialogPadre">
    <div> <a href="#close" title="Close" class="close"><i class="btn-outline-danger icofont-ui-close"></i></a>            
      <center>
        <h1>Referencias</h1><hr>
      </center>
    <table 
        class="table "
        data-toggle="table"
        data-search="true"
        data-height="460"
        data-pagination="true">
        <thead>
            <tr class="p-3 text-center text-white">
                <th>                   
                    <a href="#openModalHijo"> 
                        <i class="btn  btn-outline-success icofont-ui-add"></i>
                    </a > 
                </th>
                <th>Nom Referencia <i class="icofont-atom"></i></th>
                <th>desc Referencia  <i class="icofont-brand-appstore"></i></th>
                <th>img1 <i class="icofont-image"></i></th>
                <th>img2 <i class="icofont-image"></i></th>
                <th>Fecha Creada <i class="icofont-clock-time"></i></th>
                <th>Acciones<i class="icofont-abacus-alt"></i></th>
            </tr>
        </thead>     
      <tbody>
        <tr>
          <td>1</td>
          <td>Item 1</td> 
          <td>Item 1</td>
          <td>$1</td><td>2</td>
          <td>Item 2</td>
          <td>$2</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Item 1</td>
            <td>Item 2</td>
            <td>$2</td><td>2</td>
            <td>Item 2</td>
            <td>$2</td>
          </tr>
          <tr>
            <td>2</td>
            <td>Item 1</td>
            <td>Item 2</td>
            <td>$2</td><td>2</td>
            <td>Item 2</td>
            <td>$2</td>
          </tr>
         
      </tbody>
      
    </table>
    
    </div>  

</div>  



 

<div id="openModalHijo" class="modalDialogHijo">
    <div> <a href="#close" title="Close" class="close"><i class="icofont-ui-close"></i></a>            
      <center>
        <h1>Agregar Referencia</h1><hr>
      </center>
      
      <div class="form   form-group">
        <form id="addUser" action="">
            <div class="form-group">
              <input class="form-control" type="text" name="name" placeholder="Name" required>
            </div>
            <div class="form-group">
              <input class="form-control" type="text" name="address" placeholder="Address" required>
            </div>
            <div class="form-group">
              <input class="form-control" type="number" name="age" min="10" max="100" placeholder="Age" required>
            </div>
            <button class="btn btn-primary form-control" type="submit"  onclick="location.href='#XD'">Guardar</button>
          </form>
        </div>
    
    </div>  

</div>  












{% block javascript %}




<script>

alert("gggggggggg");

    // Create Django Ajax Call
    $("form#addUser").submit(function() {
        var nameInput = $('input[name="name"]').val().trim();
        var addressInput = $('input[name="address"]').val().trim();
        var ageInput = $('input[name="age"]').val().trim();
        if (nameInput && addressInput && ageInput) {
            // Create Ajax Call
            alert("tttttttt");
            $.ajax({
                url: '{% url "crud_ajax_create" %}',
                
                data: {
                    'name': nameInput,
                    'address': addressInput,
                    'age': ageInput
                },
                dataType: 'json',
                success: function (data) {
                    if (data.user) {
                      appendToUsrTable(data.user);
                    }
                }
            });
    
        } else {
            alert("All fields must have a valid value.");
        }
        $('form#addUser').trigger("reset");
        return false;
    });
    
    
    // Delete Django Ajax Call
    function deleteUser(id) {
      var action = confirm("Are you sure you want to delete this user?");
      if (action != false) {
        $.ajax({
            url: '{% url "crud_ajax_delete" %}',
            data: {
                'id': id,
            },
            dataType: 'json',
            success: function (data) {
                if (data.deleted) {
                  $("#userTable #user-" + id).remove();
                }
            }
        });
      }
    }
    
    
    // Create Django Ajax Call
    $("form#updateUser").submit(function() {
        var idInput = $('input[name="formId"]').val().trim();
        var nameInput = $('input[name="formName"]').val().trim();
        var addressInput = $('input[name="formAddress"]').val().trim();
        var ageInput = $('input[name="formAge"]').val().trim();
        if (nameInput && addressInput && ageInput) {
         
            // Create Ajax Call
            $.ajax({
                url: '{% url "crud_ajax_update" %}',
                data: {
                    'id': idInput,
                    'name': nameInput,
                    'address': addressInput,
                    'age': ageInput
                },
                dataType: 'json',
                success: function (data) {
                    if (data.user) {
                      updateToUserTabel(data.user);
                  }
                }
            });
    
        } else {
            alert("All fields must have a valid value.");
        }
        $('form#updateUser').trigger("reset");
        $('#myModal-referencia').modal('hide');
        
        return false;
    });
    
    
    // Update Django Ajax Call
    function editUser(id) {
    
      if (id) {
        tr_id = "#user-" + id;
        name = $(tr_id).find(".userName").text();
        address = $(tr_id).find(".userAddress").text();
        age = $(tr_id).find(".userAge").text();
        $('#form-id').val(id);
        $('#form-name').val(name);
        $('#form-address').val(address);
        $('#form-age').val(age);
      }
    }
    
    function appendToUsrTable(user) {
    
      $("#userTable > tbody:last-child").append(`
            <tr id="user-${user.id}">
                <td class="userName" name="name">${user.name}</td>
                '<td class="userAddress" name="address">${user.address}</td>
                '<td class="userAge" name="age">${user.age}</td>
                '<td align="center">
                    
                
                 
                 <a href="#openModal"
                 onClick="editUser(${user.id})"
                 class="btn btn-outline-warning form-control"
                 >Editar</a>    
    
    
                </td>
                <td align="center">
                    <button class="btn btn-outline-danger form-control" onClick="deleteUser(${user.id})">Eliminar</button>
                </td>
            </tr>
        `);
    }
    
    function updateToUserTabel(user){
    
        $("#userTable #user-" + user.id).children(".userData").each(function() {
            var attr = $(this).attr("name");
            if (attr == "name") {
              $(this).text(user.name);
            } else if (attr == "address") {
              $(this).text(user.address);
            } else {
              $(this).text(user.age);
            }
          });
    }
    </script>
    {% endblock javascript %}
